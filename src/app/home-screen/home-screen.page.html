<ion-header [translucent]="true">
  <ion-toolbar class="telldemm">
    <ion-title>
      <img src="assets/images/TELLDEMM.svg" />
    </ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="scanBarcode()">
        <img src="assets/images/qr-code.svg" />
      </ion-button>

      <ion-button (click)="openCamera()">
        <img src="assets/images/camera.svg" />
      </ion-button>

      <ion-button (click)="presentPopover($event)">
        <img src="assets/images/dots (1).svg" />
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar>
    <div class="main-header">
      <div class="container">
        <input
          type="text"
          id="searchInput"
          [(ngModel)]="searchText"
          placeholder="Ask Meta AI or Search"
        />
      </div>
    </div>

    <div class="main-filters">
      <div class="filters">
        <button
          class="filter-link"
          [ngClass]="{ 'active-filter': selectedFilter === 'all' }"
          (click)="setFilter('all')"
        >
          ALL
        </button>
        <button
          class="filter-link"
          [ngClass]="{ 'active-filter': selectedFilter === 'read' }"
          (click)="setFilter('read')"
        >
          Read
        </button>
        <button
          class="filter-link"
          [ngClass]="{ 'active-filter': selectedFilter === 'unread' }"
          (click)="setFilter('unread')"
        >
          Unread
        </button>
        <button
          class="filter-link"
          [ngClass]="{ 'active-filter': selectedFilter === 'groups' }"
          (click)="setFilter('groups')"
        >
          Groups
        </button>
      </div>
    </div>

    <div *ngIf="toggleGroupCreator" class="group-creator">
      <ion-input [(ngModel)]="newGroupName" placeholder="Enter Group Name"></ion-input>
      <ion-list>
        <ng-container *ngFor="let user of chatList">
          <ion-item *ngIf="!user.group">
            <ion-label>{{ user.name }}</ion-label>
            <ion-checkbox [(ngModel)]="user.selected"></ion-checkbox>
          </ion-item>
        </ng-container>
      </ion-list>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">

  <!-- ðŸ”„ Loader skeleton while chats load -->
  <ion-list *ngIf="isLoading">
    <ion-item *ngFor="let i of [1,2,3,4,5,6,7,8,9]">
      <ion-avatar slot="start">
        <ion-skeleton-text animated style="width: 40px; height: 40px; border-radius: 50%;"></ion-skeleton-text>
      </ion-avatar>
      <ion-label>
        <h3>
          <ion-skeleton-text animated style="width: 60%"></ion-skeleton-text>
        </h3>
        <p>
          <ion-skeleton-text animated style="width: 80%"></ion-skeleton-text>
        </p>
      </ion-label>
    </ion-item>
  </ion-list>

  <!-- âœ… Real chats once loaded -->
  <!-- <ion-list *ngIf="!isLoading">
    <ion-item *ngFor="let chat of filteredChats" (click)="openChat(chat)">
      <ion-avatar
        slot="start"
        (click)="openImagePopup(chat.group ? (chat.dp || 'assets/images/user.jfif') : (chat.profile_picture_url || 'assets/images/user.jfif')); $event.stopPropagation()">

        <img
          [src]="chat.group 
                  ? (chat.dp || 'assets/images/user.jfif') 
                  : (chat.profile_picture_url || 'assets/images/user.jfif')"
          alt="Profile" />
      </ion-avatar>

      <ion-label>
        <p class="chat-message">{{ chat.name }}</p>
        <p [style.color]="chat.unread ? '#FF1414' : '#444343'">
          <ng-container [ngSwitch]="chat.messageStatus">
            <img *ngSwitchCase="'sent'" src="assets/images/read.svg" class="tick-icon" />
            <img *ngSwitchCase="'seen'" src="assets/images/double-tick.svg" class="tick-seen" />
          </ng-container>
          {{ chat.message }}
        </p>
      </ion-label>

      <div slot="end" class="chat-meta">
        <p class="time">{{ chat.time }}</p>
        <ion-badge *ngIf="chat.unreadCount > 0" color="danger" class="unread-badge">
          {{ chat.unreadCount }}
        </ion-badge>
      </div>
    </ion-item>
  </ion-list> -->

<ion-list *ngIf="!isLoading">
  <ion-item *ngFor="let chat of filteredChats" (click)="openChat(chat)">

    <!-- Avatar -->
    <ion-avatar
      slot="start"
      (click)="openImagePopup(getChatAvatarUrl(chat) || 'assets/images/user.jfif'); $event.stopPropagation()"
    >
      <!-- Agar valid image hai to show -->
      <ng-container *ngIf="getChatAvatarUrl(chat) as img; else initialsTpl">
        <img [src]="img" alt="{{ getChatAlt(chat) }}" (error)="onAvatarError(chat)" />
      </ng-container>

      <!-- Agar image nahi to initials -->
      <ng-template #initialsTpl>
        <div class="avatar">
          {{ getChatInitial(chat) }}
        </div>
      </ng-template>
    </ion-avatar>

    <!-- Name + Message -->
    <!-- <ion-label>
      <p class="chat-message">{{ chat.group ? (chat.group_name || chat.name) : chat.name }}</p>
      <p [style.color]="chat.unread ? '#FF1414' : '#444343'">
        <ng-container [ngSwitch]="chat.messageStatus">
          <img *ngSwitchCase="'sent'" src="assets/images/read.svg" class="tick-icon" />
          <img *ngSwitchCase="'seen'" src="assets/images/double-tick.svg" class="tick-seen" />
        </ng-container>
        {{ chat.message }}
      </p>
    </ion-label> -->

    <ion-label>
        <p class="chat-message">{{ chat.group ? (chat.group_name || chat.name) : chat.name }}</p>

        <!-- MESSAGE / TYPING line -->
        <p [ngClass]="chat.isTyping ? 'typing-text' : ''" style="margin:0;">
          <ng-container *ngIf="chat.isTyping; else normalMsg">
            <!-- Group -->
            <ng-container *ngIf="chat.group">
              <ng-container *ngIf="chat.typingCount === 1">
                {{ chat.typingText ? (chat.typingText + ' is typing...') : 'Someone is typing...' }}
              </ng-container>
              <ng-container *ngIf="chat.typingCount > 1">
                {{ chat.typingCount }} people are typing...
              </ng-container>
            </ng-container>

            <!-- Private -->
            <ng-container *ngIf="!chat.group">
              {{'typing...'}}
            </ng-container>
          </ng-container>

          <ng-template #normalMsg>
            <ng-container [ngSwitch]="chat.messageStatus">
              <img *ngSwitchCase="'sent'" src="assets/images/read.svg" class="tick-icon" />
              <img *ngSwitchCase="'seen'" src="assets/images/double-tick.svg" class="tick-seen" />
            </ng-container>
            &nbsp;{{ chat.message }}
          </ng-template>
        </p>
      </ion-label>

    <!-- Time + Unread -->
    <div slot="end" class="chat-meta">
      <p class="time">{{ chat.time }}</p>
      <ion-badge *ngIf="chat.unreadCount > 0" color="danger" class="unread-badge">
        {{ chat.unreadCount }}
      </ion-badge>
    </div>
  </ion-item>
</ion-list>


  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <div class="icon-image" (click)="goToContact()">
      <img src="assets/images/user.svg" />
    </div>
  </ion-fab>

  <!-- ðŸ‘‡ Image Popup Modal -->
  <ion-modal 
    [isOpen]="showPopup" 
    (didDismiss)="closeImagePopup()" 
    [backdropDismiss]="true" 
    cssClass="custom-blur-modal">

    <ng-template>
      <div class="popup-container">
        <img [src]="selectedImage" alt="Profile Image" class="popup-image" />

        <div class="icon-row">
          <ion-icon name="chatbox-ellipses-outline" class="popup-icon" (click)="goToUserchat()"></ion-icon>
          <ion-icon name="call-outline" class="popup-icon" (click)="goToUsercall()"></ion-icon>
          <ion-icon name="videocam-outline" class="popup-icon" (click)="goToUservideocall()"></ion-icon>
          <ion-icon name="alert-circle-outline" class="popup-icon" (click)="goToUserAbout()"></ion-icon>
        </div>
      </div>
    </ng-template>
  </ion-modal>

</ion-content>

<app-footer-tabs [totalUnreadCount]="totalUnreadCount"></app-footer-tabs>
