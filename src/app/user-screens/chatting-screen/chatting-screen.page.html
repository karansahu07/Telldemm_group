<ion-header [translucent]="true">
  <ion-toolbar>

    
    <ion-buttons *ngIf="!showSearchBar" slot="start" style="color: black; width: 8%; margin-top: 15px;">
      <ion-back-button defaultHref="/home-screen"></ion-back-button>
    </ion-buttons>

  
    <ng-container *ngIf="!showSearchBar; else searchBar">
      <ion-buttons>
        <ion-item lines="none" style="--padding-start: 0; --background: white; color: black; margin-top: 15px;"
          detail="false">
          <ion-avatar slot="start">
            <img src="assets/images/user.jfif" alt="User Avatar"
              onError="this.src='assets/images/default-avatar.png'" />
          </ion-avatar>
          <ion-label (click)="goToProfile()"
            style="width: auto; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer;">
            <h2 style="margin: 0; font-size: 16px;">
              {{ chatType === 'group' ? groupName : receiver_name }}
            </h2>
          </ion-label>
        </ion-item>
      </ion-buttons>
    </ng-container>

    <ng-template #searchBar>
      <ion-item lines="none"
        style="margin-top: 10px; padding: 10px 15px; --border-radius: 25px; --background: #f5f5f5; width: 100%;">
        <ion-icon name="arrow-back-outline" slot="start" style="font-size: 24px; cursor: pointer; margin-right: 10px;"
          (click)="cancelSearch()"></ion-icon>
        <ion-input placeholder="Search messages..." [(ngModel)]="searchText" (ionInput)="onSearchInput()"
          style="margin-left: 10px; flex: 1;">
        </ion-input>
        <ion-buttons slot="end">
          <ion-button (click)="openDatePicker()">
            <ion-icon name="calendar-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="navigateSearch('up')">
            <ion-icon name="arrow-up-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="navigateSearch('down')">
            <ion-icon name="arrow-down-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-item>
    </ng-template>


    <ion-buttons *ngIf="!showSearchBar" slot="end" style="margin-top: 15px;">
      <ion-button style="color: black;">
        <ion-icon name="videocam-outline" style="font-size: 35px;"></ion-icon>
      </ion-button>
      <ion-button (click)="goToCallingScreen()" style="color: black;">
        <ion-icon name="call-outline" style="font-size: 28px;"></ion-icon>
      </ion-button>
      <ion-button (click)="openOptions($event)" style="color: black;">
        <ion-icon name="ellipsis-vertical-outline" style="font-size: 28px;"></ion-icon>
      </ion-button>
    </ion-buttons>

  </ion-toolbar>
</ion-header>




<ion-content class="chat-background" [fullscreen]="true" [scrollEvents]="true">
  <div #scrollContainer class="chat-messages" style="padding: 0 10px 80px 10px ; overflow-y: auto; min-height: 100%;">
    <ion-spinner name="dots" *ngIf="isLoadingMore" style="margin: 8px auto; display: block;"></ion-spinner>

    <div *ngFor="let group of groupedMessages">
      <div class="date-divider" [id]="'date-group-' + group.date">
        <div class="text-bg-white date-label">{{ group.date }}</div>
      </div>

      <div *ngFor="let msg of group.messages" [ngClass]="{
  'align-end': msg.sender_id === senderId,
  'align-start': msg.sender_id !== senderId,
  'selected': isSelected(msg)
}" style="display: flex; flex-direction: column; margin: 5px 0;" 
    (press)="onMessagePress(msg)" (click)="onMessageClick(msg)">

  <div class="message-bubble" (click)="openAttachmentModal(msg)" [attr.data-msg-key]="msg.key"
    [ngClass]="msg.sender_id === senderId ? 'sender-message' : 'receiver-message'">

    <!-- Sender name for group chat -->
    <span *ngIf="chatType === 'group' && msg.sender_id !== senderId"
      style="font-size: 12px; color: #6c6c6c; margin-left: 5px;">
      {{ msg.sender_name }}
    </span>

    <!-- Attachment Preview -->
    <ng-container *ngIf="msg.attachment">
      <!-- Image -->
      <img *ngIf="msg.attachment.type === 'image'" [src]="msg.attachment.base64Data" alt="Image"
        style="max-width: 200px; border-radius: 10px; margin: 5px 0;" />

      <!-- Video -->
      <video *ngIf="msg.attachment.type === 'video'" controls
        style="max-width: 200px; border-radius: 10px; margin: 5px 0;">
        <source [src]="msg.attachment.base64Data" [type]="msg.attachment.mimeType || 'video/mp4'" />
        Your browser does not support the video tag.
      </video>

      <!-- Audio -->
      <audio *ngIf="msg.attachment.type === 'audio'" controls style="margin: 5px 0;">
        <source [src]="msg.attachment.base64Data" [type]="msg.attachment.mimeType || 'audio/mpeg'" />
        Your browser does not support the audio element.
      </audio>

      <!-- File -->
      <div *ngIf="msg.attachment.type === 'file'" style="margin: 5px 0;">
        <ion-icon name="document-outline" style="margin-right: 5px;"></ion-icon>
        <a [href]="msg.attachment.base64Data" [download]="msg.attachment.fileName || 'file'"
          target="_blank" rel="noopener">
          {{ msg.attachment.fileName || 'Download File' }}
        </a>
      </div>

      <!-- Optional Caption -->
      <ion-text class="message-text" *ngIf="msg.attachment.caption">{{ msg.attachment.caption }}</ion-text>
    </ng-container>

    <!-- Text Message -->
    <ion-text class="message-text" *ngIf="!msg.attachment && msg.text">{{ msg.text }}</ion-text>

    <!-- Timestamp & Status -->
    <p class="time-stamp status-container">
      {{ msg.time }}
      <ng-container *ngIf="msg.sender_id === senderId">
        <ion-icon *ngIf="!msg.delivered" name="checkmark-outline" class="status-icon sent"></ion-icon>
        <ion-icon *ngIf="msg.delivered && !msg.read" name="checkmark-done-outline" class="status-icon delivered"></ion-icon>
        <ion-icon *ngIf="msg.delivered && msg.read" name="checkmark-done-outline" class="status-icon read"></ion-icon>
      </ng-container>
    </p>
  </div>
</div>


    </div>

  </div>
</ion-content>

<ion-modal [isOpen]="showPreviewModal" (didDismiss)="showPreviewModal = false">
  <ng-template>
    <ion-header translucent>
      <ion-toolbar>
        <ion-title>Preview Attachment</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cancelAttachment()">Cancel</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <div *ngIf="selectedAttachment?.type === 'image'">
        <img [src]="selectedAttachment?.base64" class="preview-image" />
      </div>

      <div *ngIf="selectedAttachment?.type === 'video'">
        <video controls [src]="selectedAttachment?.base64" class="preview-video"></video>
      </div>

      <div *ngIf="selectedAttachment?.type === 'file'" class="preview-file">
        <ion-icon name="document-attach-outline" style="font-size: 48px;"></ion-icon>
        <p>{{ selectedAttachment?.fileName }}</p>
      </div>

      <ion-item>
        <ion-label position="floating">Message (optional)</ion-label>
        <ion-textarea [(ngModel)]="messageText"></ion-textarea>
      </ion-item>

      <ion-button expand="block" (click)="sendMessage()">Send</ion-button>
    </ion-content>
  </ng-template>
</ion-modal>



<!-- âœ… Message Input Footer -->
<div class="footer-fixed">
  <ion-row class="footer-row">
    <ion-col class="message-input-container">
      <ion-icon name="document-text-outline" class="icon-left"></ion-icon>
      <ion-textarea [(ngModel)]="messageText" placeholder="Message" auto-grow="true" (ionInput)="onInputChange()"
        (ionFocus)="onInputFocus()" (ionBlur)="onInputBlur()" (keyup.enter)="sendMessage()"
        class="message-input"></ion-textarea>

      <!-- Attachment Icon -->
      <!-- <ion-icon name="attach-outline" class="icon-right"></ion-icon> -->

      <ion-button (click)="pickAttachment()">
        <ion-icon name="attach-outline"></ion-icon>
      </ion-button>


      <ion-icon name="camera-outline" class="icon-right"></ion-icon>
    </ion-col>
    <ion-col size="auto">
      <ion-button *ngIf="!showSendButton" class="mic-button" shape="round">
        <ion-icon slot="icon-only" name="mic"></ion-icon>
      </ion-button>
      <ion-button *ngIf="showSendButton" fill="clear" class="send-btn" shape="round" (click)="sendMessage()">
        <ion-icon slot="icon-only" name="send"></ion-icon>
      </ion-button>
    </ion-col>
  </ion-row>
</div>

<ion-modal [isOpen]="showDateModal" (didDismiss)="showDateModal = false">
  <ng-template>
    <ion-content>
      <ion-toolbar color="primary">
        <ion-title>Select Date</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="showDateModal = false">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>

      <ion-datetime presentation="date" [showDefaultButtons]="true" (ionChange)="onDateSelected($event)">
      </ion-datetime>
    </ion-content>
  </ng-template>
</ion-modal>